- name: Validate configuration (Gitlab)
  when: >
    gitlab_url | default('') | length == 0 
    or gitlab_api_key | default('') | length == 0
  set_fact:
    offboarding_results: "{{ offboarding_results + [ {
      'system': 'Gitlab',
      'status': 'Missing gitlab_url or gitlab_api_key'} ] }}"
    gitlab_validation_failed: true

- name: Search user (Gitlab)
  when: not (gitlab_validation_failed | default(false))
  uri:
    url: "{{ gitlab_url }}/api/v4/users?search={{ target_email }}"
    method: GET
    headers:
      PRIVATE-TOKEN: "{{ gitlab_api_key }}"
    return_content: true
    status_code: 200
  register: gitlab_users

- name: Pick user (Gitlab)
  when: 
    - not (gitlab_validation_failed | default(false))
    - (gitlab_users.json | default([]) | length) > 0
  set_fact:
    gitlab_user: >-
      {{
        (gitlab_users.json | default([]))
        | selectattr('email', 'equalto', target_email)
        | first | default({})
      }}

- name: Block user (Gitlab)
  when:
    - not (gitlab_validation_failed | default(false))
    - (gitlab_users.json | default([]) | length) > 0
    - gitlab_user.state == "active"
  uri:
    url: "{{ gitlab_url }}/api/v4/users/{{ gitlab_user.id }}/block"
    method: POST
    headers:
      PRIVATE-TOKEN: "{{ gitlab_api_key }}"
    status_code: 201

# --- REPORTING ---

- name: Record GitLab result
  when: not (gitlab_validation_failed | default(false))
  set_fact:
    offboarding_results: "{{ offboarding_results + [ {
      'system': 'Gitlab',
      'status': (
        'User not found' if (gitlab_users.json | default([]) | length) == 0
        else ('User already blocked' if gitlab_user.state == 'blocked' 
        else 'User deactivated' )
      )} ] }}"