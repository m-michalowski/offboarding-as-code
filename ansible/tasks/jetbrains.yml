- name: Validate configuration (Jetbrains)
  when: >
    (jetbrains_url | default('') | length == 0) 
    or (jetbrains_api_key | default('') | length == 0)
    or (jetbrains_customer_id | default('') | length == 0)
  set_fact:
    offboarding_results: "{{ offboarding_results + [ {
      'system': 'jetbrains',
      'status': 'Missing jetbrains_url, jetbrains_api_key or jetbrains_customer_id'} ] }}"
    jetbrains_validation_failed: true

- name: Revoke user licences (Jetbrains)
  when: not (jetbrains_validation_failed | default(false))
  uri:
    url: "{{ jetbrains_url }}/api/v1/customer/licenses/revoke?email={{ target_email }}"
    method: POST
    headers:
      X-Customer-Code: "{{ jetbrains_customer_id }}"
      X-Api-Key: "{{ jetbrains_api_key }}"
      accept: "application/json"
    return_content: true
    status_code: [200, 400]
  register: jetbrains_revoke
  failed_when: >
    jetbrains_revoke.status != 200
    and not (
      jetbrains_revoke.status == 400
      and (jetbrains_revoke.json.code | default('')) == 'RECENTLY_ASSIGNED_LICENSE_IS_NOT_AVAILABLE_FOR_REVOKE'
    )

- name: Record Jetbrains result
  when: not (jetbrains_validation_failed | default(false))
  set_fact:
    offboarding_results: "{{ offboarding_results + [ {
      'system': 'Jetbrains',
      'status': (
        'No licences assigned'
        if (
          jetbrains_revoke.status == 200
          and (jetbrains_revoke.json.revokedLicenses | default([]) | length) == 0
        )
        else (
          'Licences revoked'
          if jetbrains_revoke.status == 200
          else 'Recently assigned license cannot be revoked yet'
        )
      ),
      'details': (
        (
          { 'revoked_count': (jetbrains_revoke.json.revokedLicenses | default([]) | length) }
          if jetbrains_revoke.status == 200
          else { 'code': jetbrains_revoke.json.code }
        )
      )} ] }}"
